---
import { Icon } from "astro-icon/components";
import Alert from "./app/Alert.astro";
import Button from "./app/Button.astro";
import Container from "./app/Container.astro";
import Input from "./app/Input.astro";
---

<section class="bg-red-900 text-white py-20 relative">
    <div class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.1)_1px,transparent_1px)] bg-[size:100%_30px]"></div>

    <Container class="relative">
        <form action="" class="mx-auto space-y-4 text-center flex flex-col items-center md:max-w-1/2" id="subscribe-form">
            <div class="space-y-2">
                <h2 class="font-bold text-3xl xl:text-4xl">Subscribe Newsletter</h2>
                <p class="text-lg text-gray-200">Subscribe ke newsletter kami agar langsung mendapatkan email notifikasi ketika ada konten baru dari kami.</p>
            </div>
            <Alert message="Terima kasih sudah subscribe! Nantikan konten terbaru langsung di inbox email kamu." class="hidden" id="subscribe-alert-success" />
            <div class="flex flex-col gap-2 md:flex-row">
                <Input type="email" placeholder="Masukkan email Anda" color="light" bordered={false} name="email" required />
                <Button color="secondary" class="group">
                    <Icon name={'tabler:loader'} class={'hidden group-[.loading]:block animate-spin'} />
                    Subscribe</Button>
            </div>
        </form>
    </Container>
</section>

<script>
const subscribeForm = document.querySelector('#subscribe-form')
const alertSuccess = document.querySelector('#subscribe-alert-success')

if (subscribeForm) {
    const submitButton = subscribeForm.querySelector('button')

    subscribeForm?.addEventListener('submit', async e => {
        e.preventDefault()

        alertSuccess?.classList.add('hidden')
        submitButton?.classList.add('loading')
        submitButton?.setAttribute('disabled', 'disabled')

        try {
            const res = await fetch(`${import.meta.env.PUBLIC_FORM_API_URL}/subscribe`, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: subscribeForm.querySelector<HTMLInputElement>('input[type=email]')?.value
                })
            })

            if (res.status === 200) {
                alertSuccess?.classList.remove('hidden')
            }
        } finally {
            submitButton?.classList.remove('loading')
            submitButton?.removeAttribute('disabled')
        }
    })
}
</script>